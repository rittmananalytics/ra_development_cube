cubes:
- description: invoices_fact
  dimensions:
  - name: company_id
    public: false
    sql: '{CUBE}.company_id'
    type: string
  - name: company_fk
    public: false
    sql: '{CUBE}.company_fk'
    type: string
  - name: invoice_sent_at_ts
    public: false
    sql: '{CUBE}.invoice_sent_at_ts'
    type: time
  - name: invoice_creator_users_id
    public: false
    sql: '{CUBE}.invoice_creator_users_id'
    type: string
  - name: invoice_currency
    sql: '{CUBE}.invoice_currency'
    type: string
  - name: invoice_number
    public: false
    sql: '{CUBE}.invoice_number'
    type: string
  - name: invoice_payment_term
    public: false
    sql: '{CUBE}.invoice_payment_term'
    type: string
  - name: invoice_pk
    public: false
    sql: '{CUBE}.invoice_pk'
    type: string
  - name: invoice_seq
    sql: '{CUBE}.invoice_seq'
    type: number
  - name: invoice_status
    sql: '{CUBE}.invoice_status'
    type: string
  - name: invoice_subject
    sql: '{CUBE}.invoice_subject'
    type: string
  - name: invoice_tax_rate_pct
    public: false
    sql: '{CUBE}.invoice_tax_rate_pct'
    type: number
  - name: invoice_total_days_overdue
    public: false
    sql: '{CUBE}.invoice_total_days_overdue'
    type: number
  - name: invoice_total_days_to_pay
    public: false
    sql: '{CUBE}.invoice_total_days_to_pay'
    type: number
  - name: invoice_total_days_variance_on_payment_terms
    public: false
    sql: '{CUBE}.invoice_total_days_variance_on_payment_terms'
    type: number
  - name: invoice_type
    sql: '{CUBE}.invoice_type'
    type: string
  - name: months_since_first_invoice
    public: true
    sql: '{CUBE}.months_since_first_invoice'
    type: number
  - name: months_before_last_invoice
    public: false
    sql: '{CUBE}.months_before_last_invoice'
    type: number
  - name: is_invoice_in_clients_last_12m
    public: false
    sql: '{months_before_last_invoice} < 12'
    type: boolean
  - name: invoice_months_before_now
    public: false
    sql: '{CUBE}.invoice_months_before_now'
    type: number
  - name: project_id
    public: true
    sql: '{CUBE}.project_id'
    type: string
  - name: quarters_since_first_invoice
    public: false
    sql: '{CUBE}.quarters_since_first_invoice'
    type: number
  - name: timesheet_project_fk
    public: false
    sql: '{CUBE}.timesheet_project_fk'
    type: string
  - name: total_local_amount
    public: false
    sql: '{CUBE}.total_local_amount'
    type: number
  - name: invoice_local_total_revenue_amount
    public: false
    sql: '{CUBE}.invoice_local_total_revenue_amount'
    type: number
  - name: invoice_gbp_amount
    public: false
    sql: case when {CUBE}.total_gbp_amount is null then {CUBE}.total_local_amount
      / {exchange_rates.currency_rate} else {CUBE}.total_gbp_amount end
    type: number
  - name: invoice_local_total_tax_amount
    public: false
    sql: '{CUBE}.total_local_amount * (safe_cast({CUBE}.invoice_tax_rate_pct as float64)
      / 100)'
    type: number
  - name: invoice_currency_rate
    public: false
    sql: case when {CUBE}.invoice_currency_rate is null or {CUBE}.invoice_currency_rate
      = 0 then {exchange_rates.currency_rate} else {CUBE}.invoice_currency_rate end
    type: number
  - name: invoice_gbp_tax_amount
    public: false
    sql: '{invoice_gbp_amount} * (safe_cast({CUBE}.invoice_tax_rate_pct as float64)
      / 100)'
    type: number
  - name: invoice_gbp_net_amount
    public: false
    sql: '{invoice_gbp_amount}'
    type: number
  - name: first_invoice
    sql: '{CUBE}.first_invoice_month'
    type: time
  - name: last_invoice
    public: false
    sql: '{CUBE}.last_invoice_month'
    type: time
  - name: invoice
    public: false
    sql: '{CUBE}.invoice_sent_at_ts'
    type: time
  - name: invoice_due
    public: true
    sql: '{CUBE}.invoice_due_at_ts'
    type: time
  - name: invoice_payment
    public: false
    sql: "CASE\n          WHEN timestamp({payments_fact.payment_date}) is not null\
      \ then timestamp({payments_fact.payment_date})\n          WHEN {CUBE}.expected_payment_at_ts\
      \ < current_timestamp AND {CUBE}.invoice_due_at_ts < current_timestamp THEN\
      \ current_timestamp\n          WHEN {CUBE}.expected_payment_at_ts IS NULL THEN\
      \ {CUBE}.invoice_due_at_ts\n          ELSE {CUBE}.expected_payment_at_ts\n \
      \       END"
    type: time
  - name: invoice_issued
    public: true
    sql: '{CUBE}.invoice_issue_at_ts'
    type: time
  - name: expected_payment
    public: true
    sql: '{CUBE}.expected_payment_at_ts'
    type: time
  - name: invoice_paid
    public: false
    sql: '{CUBE}.invoice_paid_at_ts'
    type: time
  - name: invoice_period_end_at_ts
    public: false
    sql: '{CUBE}.invoice_period_end_at_ts'
    type: time
  - name: invoice_period_start_at_ts
    public: false
    sql: '{CUBE}.invoice_period_start_at_ts'
    type: time
  - name: invoice_sent_at_ts
    public: false
    sql: '{CUBE}.invoice_sent_at_ts'
    type: time
  joins: []
  measures:
  - name: customer_total_active_months
    public: false
    sql: '{invoice_issued_month}'
    type: count_distinct_approx
  - name: invoice_gbp_revenue_amount
    public: false
    sql: "case when lower({CUBE}.invoice_status) in ('open','paid') then\n       \
      \   case when {CUBE}.invoice_currency = 'USD' then {CUBE}.invoice_local_total_revenue_amount\
      \ * 0.73\n                when {CUBE}.invoice_currency = 'CAD' then {CUBE}.invoice_local_total_revenue_amount\
      \ * 0.57\n                when {CUBE}.invoice_currency = 'EUR' then {CUBE}.invoice_local_total_revenue_amount\
      \ * 0.85\n                else {CUBE}.invoice_local_total_revenue_amount   end\n\
      \          end"
    type: sum
  - name: total_invoice_gbp_amount_in_clients_last_12m
    public: false
    sql: "case when {CUBE}.invoice_currency = 'USD' then {CUBE}.invoice_local_total_revenue_amount\
      \ * 0.75\n    when {CUBE}.invoice_currency = 'CAD' then {CUBE}.invoice_local_total_revenue_amount\
      \ * 0.58\n    when {CUBE}.invoice_currency = 'EUR' then {CUBE}.invoice_local_total_revenue_amount\
      \ * 0.90\n    else {CUBE}.invoice_local_total_revenue_amount  end"
    type: sum
  - name: total_gross_amount_local
    public: false
    sql: '{CUBE}.total_local_amount'
    type: sum
  - name: total_tax_local
    public: false
    sql: '{invoice_local_total_tax_amount}'
    type: sum
  - name: total_net_amount_local
    public: false
    sql: '{total_local_amount} - coalesce({invoice_local_total_tax_amount},0)'
    type: sum
  - name: total_gross_amount_gbp
    public: false
    sql: '{invoice_gbp_amount}'
    type: sum
  - name: total_tax_gbp
    public: false
    sql: '{invoice_gbp_tax_amount}'
    type: sum
  - name: total_net_amount_gbp
    public: true
    sql: '{invoice_gbp_amount} - coalesce({invoice_gbp_tax_amount},0)'
    type: sum
  - name: total_invoiced_net_amount_gbp
    sql: '{invoice_gbp_amount} - coalesce({invoice_gbp_tax_amount},0)'
    type: sum
  - name: total_uninvoiced_net_amount_gbp
    sql: '{invoice_gbp_amount} - coalesce({invoice_gbp_tax_amount},0)'
    type: sum
  - name: count_invoices
    public: false
    sql: '{CUBE}.invoice_pk'
    type: count_distinct_approx
  - name: total_invoice_count_in_clients_last_12m
    public: false
    sql: '{CUBE}.invoice_pk'
    type: count_distinct_approx
  name: invoices_fact
  sql_table: '`{{ _user_attributes[''dataset''] }}.invoices_fact`'
